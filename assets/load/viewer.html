<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Markdown Viewer with Controls</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Georgia', serif;
            background: #f5f5f5;
            margin: 0;
        }

        #pages-container {
            max-width: 900px;
            margin: 40px auto 100px auto;
            /* leave space for fixed bar */
        }

        .page {
            background: white;
            width: 100%;
            /* A4 width */
            height: 1123px;
            /* A4 height */
            margin: 0 auto 20px auto;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            overflow: hidden;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
        }

        code,
        pre {
            background-color: #f0f0f0;
            padding: 8px;
            border-radius: 5px;
            display: block;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table,
        th,
        td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        blockquote {
            background: #eef;
            padding: 15px;
            border-left: 5px solid #88f;
            margin: 20px 0;
        }

        /* Fixed bottom control bar */
        #control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            padding: 10px 20px;
            border-top: 1px solid #ccc;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 12px;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        #control-bar button {
            padding: 8px 14px;
            font-size: 16px;
            cursor: pointer;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 6px;
        }

        #control-bar button:hover {
            background: #005f9e;
        }

        #control-bar input[type="text"] {
            padding: 6px 10px;
            font-size: 14px;
            width: 150px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        #control-bar input[type="range"] {
            width: 150px;
        }

        #fontSizeDisplay,
        #pageIndicator {
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <center>
        <h1 id="dynamic-title">üìò Loading...</h1>
        <h3 id="unit-title" style="text-align:center; margin-top: -10px;"></h3>

    </center>
    <div id="pages-container"></div>

    <!-- Control bar -->
    <div id="control-bar">
        <button onclick="adjustFontSize(-1)">‚ûñ</button>
        <span id="fontSizeDisplay">16px</span>
        <button onclick="adjustFontSize(1)">‚ûï</button>

        <input type="text" id="searchInput" placeholder="üîç Search..." oninput="searchText()" />

        <input type="range" id="pageSlider" min="1" step="1" value="1" onchange="goToPage(this.value)">
        <span id="pageIndicator">Page 1</span>

        <button onclick="toggleViewMode()">üåÄ Toggle View Mode</button>


        <button onclick="generatePDF()">‚¨áÔ∏è Download PDF</button>
    </div>
<iframe id="pdf-frame"></iframe>

    <script>
  async function getDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open("OfflinePDFDB", 1);
      request.onsuccess = (event) => {
        resolve(event.target.result);
      };
      request.onerror = (event) => {
        reject(event.target.error);
      };
    });
  }

  function showPDF(url) {
    const iframe = document.getElementById("pdf-frame");
    if (iframe) {
      iframe.src = url;
    } else {
      const newIframe = document.createElement("iframe");
      newIframe.id = "pdf-frame";
      newIframe.src = url;
      newIframe.style.width = "100%";
      newIframe.style.height = "100vh";
      newIframe.style.border = "none";
      document.body.appendChild(newIframe);
    }
  }

  async function loadOfflineFile(key) {
    try {
      const db = await getDB();
      const tx = db.transaction("mdfiles", "readonly");
      const store = tx.objectStore("mdfiles");
      const request = store.get(key);

      request.onsuccess = () => {
        const blob = request.result;
        if (blob) {
          const blobUrl = URL.createObjectURL(blob);
          showPDF(blobUrl);
        } else {
          document.body.innerHTML = "<p style='padding:20px;'>‚ö†Ô∏è File not found in offline storage.</p>";
        }
      };

      request.onerror = () => {
        document.body.innerHTML = "<p style='padding:20px;'>‚ùå Failed to read from offline storage.</p>";
      };
    } catch (err) {
      console.error(err);
      document.body.innerHTML = "<p style='padding:20px;'>‚ùå Error loading offline file.</p>";
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const offlineParam = params.get("offline");
    const fileParam = params.get("file");

    if (offlineParam) {
      const key = atob(offlineParam);
      loadOfflineFile(key);
    } else if (fileParam) {
      showPDF(fileParam);
    } else {
      document.body.innerHTML = "<p style='padding:20px;'>‚ùå No file specified. Please open a PDF via a valid link.</p>";
    }
  });
</script>

</body>

</html>